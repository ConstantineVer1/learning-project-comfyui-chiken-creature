# Практическое упражнение: Simple Inpainting Method

## ⚠️ ДОКУМЕНТ НЕПОЛНЫЙ - ТРЕБУЕТ ПЕРЕРАБОТКИ ⚠️

**СТАТУС**: DRAFT - НЕ ГОТОВ ДЛЯ ИСПОЛЬЗОВАНИЯ

**Выявленные проблемы**:
- 15 критических ошибок в workflow описании
- Отсутствуют необходимые узлы и соединения
- Неполные параметры nodes
- Workflow невозможно построить по данным инструкциям
- Требуется полное переписывание с тестированием

**Для использования**: Дождитесь исправленной версии с рабочим .json workflow файлом

---

## Цель
Научиться базовому методу создания гибрида через inpainting - самый простой, но эффективный способ.

## Что мы будем делать
1. Генерировать курицу в полный рост
2. Вырезать голову из фото человека
3. Заменять голову курицы на человеческую
4. Сглаживать переход через inpainting

## Подготовка

### Шаг 1: Установите необходимые nodes
```bash
# Через ComfyUI Manager найдите и установите:
1. ComfyUI-Impact-Pack (для SAM)
2. WAS Node Suite (утилиты для масок)
3. ComfyUI-Masquerade (продвинутые маски)
```

### Шаг 2: Скачайте модели
```
1. SD 1.5 Inpainting:
   - Скачайте: sd-v1-5-inpainting.ckpt или runwayml-inpainting
   - Положите в папку: models/checkpoints/

2. SAM Model (segment anything):
   - Скачайте: sam_vit_h_4b8939.pth (наиболее точный) или sam_vit_b/l варианты
   - Положите в папку: models/sams/
   - ПРИМЕЧАНИЕ: SAM автоматически сегментирует объекты, включая лица и головы
   - Отдельная Face Detection модель НЕ требуется для этого упражнения
```

## Workflow построение - пошагово

### Этап 1: Генерация базовой курицы
```
Nodes нужны:
1. CheckpointLoaderSimple → загрузка модели
2. EmptyLatentImage → 512x768 (вертикальная ориентация)
3. CLIPTextEncode (positive) → промпт курицы
4. CLIPTextEncode (negative) → что исключить
5. KSampler → генерация
6. VAEDecode → декодирование
7. SaveImage → сохранение
```

**Промпт для курицы:**
```
Positive:
"full body anthropomorphic chicken, standing upright,
humanoid posture, wearing simple clothes, white background,
centered composition, leaving space for head"

Negative:
"human, human head, human face, close-up, cropped"
```

### Этап 2: Подготовка человеческой головы

**Вариант А: Автоматическая сегментация**
```
Nodes:
1. LoadImage → ваше фото
2. SAMModelLoader → загрузка SAM
3. ImpactSAMDetector → детекция лица
4. MaskToImage → конвертация маски
```

**Вариант Б: Ручная маска**
```
Nodes:
1. LoadImage → фото
2. LoadImageMask → заранее подготовленная маска
```

### Этап 3: Композитинг

```
Nodes для объединения:
1. ImageCompositeMasked
   - destination: курица
   - source: голова человека
   - mask: маска позиции головы

2. ImageBlend
   - blend_mode: normal
   - blend_factor: 1.0
```

### Этап 4: Inpainting для сглаживания

```
Nodes:
1. VAEEncode → кодирование композита
2. InpaintModelConditioning → подготовка для inpainting
3. KSampler
   - denoise: 0.5 (начните с этого)
   - steps: 20
   - CFG: 7
4. VAEDecode → финальное изображение
```

**Промпт для inpainting области шеи:**
```
"smooth transition between human skin and chicken feathers,
natural neck connection, integrated creature, fantasy art"
```

## Параметры для экспериментов

### Тест 1: Сила denoise
- 0.3 - минимальные изменения
- 0.5 - сбалансированно
- 0.7 - сильное изменение
- 0.9 - почти полная перегенерация

### Тест 2: Размер маски перехода
- 4 pixels - резкий переход
- 8 pixels - мягкий
- 16 pixels - очень плавный
- 32 pixels - размытый

### Тест 3: CFG Scale для inpainting
- 5 - больше свободы
- 7 - баланс
- 10 - строгое следование промпту

## Проблемы и решения

### Проблема 1: Голова слишком большая/маленькая
**Решение:**
```python
# Добавьте node ImageScale
scale_factor = 0.8  # или 1.2 для увеличения
```

### Проблема 2: Разное освещение
**Решение:**
```
Добавьте nodes:
- ColorCorrect (из WAS Node Suite)
- ImageLevels (регулировка яркости)
```

### Проблема 3: Резкая граница
**Решение:**
```
1. Увеличьте Mask Blur
2. Используйте FeatherMask node
3. Примените GaussianBlur к маске
```

## Домашнее задание

### Уровень 1: Базовый
1. Создайте 5 разных куриц-основ
2. Попробуйте 3 разных фото людей
3. Найдите оптимальный denoise

### Уровень 2: Улучшения
1. Добавьте тень под подбородком
2. Сделайте перья на шее переходящими в кожу
3. Подберите освещение

### Уровень 3: Вариации
1. Курица в костюме с галстуком
2. Курица-воин в доспехах
3. Курица-маг в мантии

## Метрики успеха

Запишите для каждого результата:
- [ ] Время генерации
- [ ] Количество попыток до успеха
- [ ] Параметры лучшего результата
- [ ] Что можно улучшить

## Вопросы для понимания

1. **Почему мы используем inpainting model, а не обычную?**
   - Подсказка: как inpainting model обучена работать с масками?

2. **Что происходит при denoise = 1.0 vs 0.0?**
   - Попробуйте и объясните разницу

3. **Как mask blur влияет на результат?**
   - Сравните 0, 8, 32 pixels

4. **Можно ли сделать это без SAM?**
   - Какие альтернативы для создания масок?

## Следующий шаг
После освоения простого метода, переходите к Method 2 с ControlNet для более профессиональных результатов!